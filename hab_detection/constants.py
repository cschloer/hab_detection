import torch
import numpy as np

ZIP_PATH_TRAIN = "/shared/datasets/hab/new_data/dataset_train.zip"
ZIP_PATH_TEST = "/shared/datasets/hab/new_data/dataset_test.zip"
# ZIP_PATH_TRAIN = "/shared/datasets/hab/data/dataset4_train.zip"
# ZIP_PATH_TEST = "/shared/datasets/hab/data/dataset4_test.zip"
# ZIP_PATH_TRAIN = "/shared/datasets/hab/data/dataset_dist_train.zip"
# ZIP_PATH_TEST = "/shared/datasets/hab/data/dataset_dist_test.zip"
# ZIP_PATH_TRAIN = "/home/conrad/new_data/dataset_train.zip"
# ZIP_PATH_TEST = "/home/conrad/new_data/dataset_test.zip"

# STRUCTURED_FOLDER_PATH_TRAIN = "/shared/datasets/hab/new_data/dataset_train_structured"
# STRUCTURED_FOLDER_PATH_TEST = "/shared/datasets/hab/new_data/dataset_test_structured"
STRUCTURED_FOLDER_PATH_TRAIN = "/ssd/hab/data/dataset_train_structured"
STRUCTURED_FOLDER_PATH_TEST = "/ssd/hab/data/dataset_test_structured"

# MODEL_SAVE_BASE_FOLDER = "/shared/datasets/hab/models"
MODEL_SAVE_BASE_FOLDER = "/home/conrad/results/models"
LOG_NAME = "log.txt"

# FULL_IMAGE_BASE_FOLDER = "/shared/datasets/hab/images"
FULL_IMAGE_BASE_FOLDER = "/home/conrad/results/images"


device = torch.device("cuda") if torch.cuda.is_available() else torch.device("cpu")
print(device)

# Dataset mean and std calculated using run_dataset_staticics.py
# For old dataset
"""
dataset_mean = [
    0.04235201,
    0.04784579,
    0.05547756,
    0.04363304,
    0.05092298,
    0.05012781,
    0.05277098,
    0.05194422,
    0.05095484,
    0.05174823,
    0.03550878,
    0.02762647,
]
dataset_std = [
    0.05505946,
    0.05726197,
    0.0569017,
    0.0569323,
    0.06115186,
    0.07730392,
    0.0840756,
    0.08879628,
    0.08847726,
    0.10554088,
    0.06592033,
    0.05038361,
]
"""
# For new dataset
dataset_mean = [
    0.0367425,
    0.04384967,
    0.05643992,
    0.04752899,
    0.05311135,
    0.04531556,
    0.04827843,
    0.04772811,
    0.04578368,
    0.04437868,
    0.03240987,
    0.02406007,
]
dataset_std = [
    0.04898498,
    0.05039225,
    0.05055515,
    0.05064571,
    0.05497834,
    0.0692344,
    0.07566278,
    0.08037745,
    0.08150004,
    0.10058163,
    0.06478662,
    0.04916096,
]
cyan_colormap = np.array(
    [
        [149, 149, 149, 255],
        [71, 24, 106, 255],
        [71, 25, 107, 255],
        [71, 27, 109, 255],
        [71, 29, 111, 255],
        [71, 31, 112, 255],
        [71, 32, 113, 255],
        [71, 33, 114, 255],
        [71, 34, 115, 255],
        [70, 36, 116, 255],
        [70, 38, 118, 255],
        [70, 39, 119, 255],
        [70, 41, 120, 255],
        [70, 42, 121, 255],
        [70, 43, 122, 255],
        [69, 44, 123, 255],
        [69, 47, 124, 255],
        [69, 48, 125, 255],
        [68, 49, 126, 255],
        [68, 51, 126, 255],
        [68, 52, 127, 255],
        [68, 53, 128, 255],
        [67, 56, 129, 255],
        [66, 57, 130, 255],
        [66, 58, 130, 255],
        [66, 59, 131, 255],
        [65, 60, 131, 255],
        [65, 61, 132, 255],
        [64, 64, 133, 255],
        [64, 65, 133, 255],
        [63, 66, 134, 255],
        [63, 67, 134, 255],
        [62, 68, 134, 255],
        [62, 70, 135, 255],
        [61, 72, 136, 255],
        [60, 73, 136, 255],
        [60, 74, 136, 255],
        [60, 75, 136, 255],
        [59, 76, 137, 255],
        [59, 77, 137, 255],
        [58, 80, 137, 255],
        [57, 81, 138, 255],
        [57, 82, 138, 255],
        [56, 83, 138, 255],
        [56, 84, 138, 255],
        [55, 85, 138, 255],
        [54, 87, 139, 255],
        [54, 88, 139, 255],
        [53, 89, 139, 255],
        [53, 90, 139, 255],
        [52, 91, 139, 255],
        [52, 92, 139, 255],
        [51, 94, 140, 255],
        [50, 95, 140, 255],
        [50, 96, 140, 255],
        [49, 97, 140, 255],
        [49, 98, 140, 255],
        [48, 99, 140, 255],
        [48, 101, 140, 255],
        [47, 102, 140, 255],
        [47, 103, 140, 255],
        [46, 104, 140, 255],
        [46, 105, 140, 255],
        [45, 107, 141, 255],
        [45, 108, 141, 255],
        [44, 109, 141, 255],
        [44, 110, 141, 255],
        [43, 111, 141, 255],
        [43, 112, 141, 255],
        [42, 114, 141, 255],
        [42, 115, 141, 255],
        [41, 116, 141, 255],
        [41, 117, 141, 255],
        [41, 118, 141, 255],
        [40, 119, 141, 255],
        [39, 121, 141, 255],
        [39, 121, 141, 255],
        [39, 122, 141, 255],
        [38, 123, 141, 255],
        [38, 124, 141, 255],
        [38, 125, 141, 255],
        [37, 127, 141, 255],
        [37, 128, 141, 255],
        [36, 129, 141, 255],
        [36, 130, 140, 255],
        [35, 131, 140, 255],
        [35, 132, 140, 255],
        [34, 134, 140, 255],
        [34, 135, 140, 255],
        [34, 136, 140, 255],
        [33, 136, 140, 255],
        [33, 137, 140, 255],
        [33, 138, 140, 255],
        [32, 140, 139, 255],
        [32, 141, 139, 255],
        [31, 142, 139, 255],
        [31, 143, 139, 255],
        [31, 144, 139, 255],
        [30, 145, 139, 255],
        [30, 147, 138, 255],
        [30, 148, 138, 255],
        [30, 149, 138, 255],
        [29, 150, 137, 255],
        [29, 151, 137, 255],
        [29, 152, 137, 255],
        [29, 153, 136, 255],
        [29, 154, 136, 255],
        [29, 155, 136, 255],
        [29, 156, 135, 255],
        [29, 157, 135, 255],
        [29, 158, 135, 255],
        [30, 160, 134, 255],
        [30, 161, 133, 255],
        [30, 162, 133, 255],
        [31, 163, 132, 255],
        [31, 164, 132, 255],
        [32, 165, 132, 255],
        [33, 166, 131, 255],
        [34, 167, 130, 255],
        [34, 168, 129, 255],
        [35, 169, 129, 255],
        [36, 170, 128, 255],
        [37, 171, 128, 255],
        [39, 173, 126, 255],
        [40, 174, 126, 255],
        [41, 175, 125, 255],
        [42, 176, 124, 255],
        [43, 176, 124, 255],
        [45, 177, 123, 255],
        [47, 179, 121, 255],
        [49, 180, 121, 255],
        [50, 181, 120, 255],
        [52, 182, 119, 255],
        [53, 183, 118, 255],
        [56, 184, 117, 255],
        [58, 185, 116, 255],
        [60, 186, 115, 255],
        [61, 187, 114, 255],
        [63, 188, 113, 255],
        [65, 189, 112, 255],
        [68, 190, 110, 255],
        [70, 191, 109, 255],
        [72, 192, 108, 255],
        [74, 193, 107, 255],
        [76, 193, 106, 255],
        [78, 194, 104, 255],
        [82, 196, 102, 255],
        [84, 197, 101, 255],
        [86, 197, 100, 255],
        [88, 198, 99, 255],
        [90, 199, 97, 255],
        [93, 200, 96, 255],
        [97, 201, 94, 255],
        [99, 202, 92, 255],
        [102, 203, 91, 255],
        [104, 203, 90, 255],
        [106, 204, 88, 255],
        [108, 205, 87, 255],
        [113, 206, 84, 255],
        [115, 207, 83, 255],
        [118, 207, 81, 255],
        [120, 208, 80, 255],
        [123, 209, 78, 255],
        [125, 209, 77, 255],
        [130, 210, 74, 255],
        [133, 211, 72, 255],
        [135, 212, 70, 255],
        [138, 212, 69, 255],
        [140, 213, 67, 255],
        [143, 213, 66, 255],
        [148, 214, 62, 255],
        [150, 215, 61, 255],
        [153, 215, 59, 255],
        [156, 216, 57, 255],
        [158, 216, 55, 255],
        [161, 217, 54, 255],
        [166, 218, 50, 255],
        [169, 218, 49, 255],
        [172, 219, 47, 255],
        [174, 219, 45, 255],
        [177, 220, 43, 255],
        [180, 220, 42, 255],
        [185, 221, 38, 255],
        [188, 221, 37, 255],
        [190, 222, 35, 255],
        [193, 222, 33, 255],
        [196, 222, 32, 255],
        [198, 223, 30, 255],
        [203, 219, 27, 255],
        [209, 216, 24, 255],
        [215, 214, 21, 255],
        [218, 210, 21, 255],
        [220, 206, 19, 255],
        [223, 201, 18, 255],
        [225, 196, 16, 255],
        [227, 191, 15, 255],
        [229, 187, 14, 255],
        [231, 182, 12, 255],
        [234, 177, 11, 255],
        [236, 173, 10, 255],
        [238, 168, 8, 255],
        [240, 163, 7, 255],
        [242, 158, 5, 255],
        [245, 154, 4, 255],
        [247, 149, 3, 255],
        [249, 144, 1, 255],
        [251, 139, 0, 255],
        [254, 135, 0, 255],
        [254, 130, 0, 255],
        [254, 124, 0, 255],
        [254, 119, 0, 255],
        [254, 114, 0, 255],
        [254, 109, 0, 255],
        [254, 103, 0, 255],
        [254, 98, 0, 255],
        [254, 93, 0, 255],
        [254, 88, 0, 255],
        [254, 82, 0, 255],
        [254, 77, 0, 255],
        [254, 72, 0, 255],
        [254, 67, 0, 255],
        [254, 61, 0, 255],
        [254, 56, 0, 255],
        [254, 51, 0, 255],
        [254, 46, 0, 255],
        [254, 40, 0, 255],
        [254, 35, 0, 255],
        [254, 30, 0, 255],
        [254, 25, 0, 255],
        [254, 19, 0, 255],
        [254, 14, 0, 255],
        [254, 9, 0, 255],
        [254, 4, 0, 255],
        [253, 0, 0, 255],
        [248, 0, 0, 255],
        [243, 0, 0, 255],
        [237, 0, 0, 255],
        [232, 0, 0, 255],
        [227, 0, 0, 255],
        [222, 0, 0, 255],
        [216, 0, 0, 255],
        [211, 0, 0, 255],
        [206, 0, 0, 255],
        [201, 0, 0, 255],
        [195, 0, 0, 255],
        [190, 0, 0, 255],
        [185, 0, 0, 255],
        [180, 0, 0, 255],
        [174, 0, 0, 255],
        [169, 0, 0, 255],
        [169, 0, 0, 255],
        [169, 0, 0, 255],
        [169, 0, 0, 255],
        [169, 0, 0, 255],
        [229, 216, 202, 255],
        [0, 0, 0, 255],
    ]
)

all_dist = np.array(
    # Artifically increase weight of 0 (it's actually 1.00000000e00)
    [
        1.00000000e00,
        2.16892474e02,
        2.81664363e02,
        3.26735423e02,
        3.63356316e02,
        3.93812679e02,
        4.19998943e02,
        4.44209097e02,
        4.63926076e02,
        4.81457714e02,
        4.98040944e02,
        5.12962344e02,
        5.26344011e02,
        5.38808297e02,
        5.48777701e02,
        5.59450094e02,
        5.67691844e02,
        5.76649957e02,
        5.83178779e02,
        5.89517635e02,
        5.93749346e02,
        5.99720669e02,
        6.02946284e02,
        6.07410748e02,
        6.11657545e02,
        6.14082916e02,
        6.16104000e02,
        6.18886655e02,
        6.19711345e02,
        6.20714744e02,
        6.20599118e02,
        6.20611460e02,
        6.20799948e02,
        6.20924297e02,
        6.19812688e02,
        6.19821716e02,
        6.16102378e02,
        6.16091430e02,
        6.13392873e02,
        6.12829116e02,
        6.09185843e02,
        6.06333210e02,
        6.03657771e02,
        6.00295582e02,
        5.98028496e02,
        5.97478507e02,
        5.93476078e02,
        5.91624802e02,
        5.87433902e02,
        5.83837799e02,
        5.80588474e02,
        5.78635939e02,
        5.75195192e02,
        5.72234808e02,
        5.68733381e02,
        5.65016961e02,
        5.63293984e02,
        5.59545393e02,
        5.55513561e02,
        5.53865010e02,
        5.50291239e02,
        5.46900641e02,
        5.43589127e02,
        5.39821155e02,
        5.36973448e02,
        5.33468023e02,
        5.31093512e02,
        5.27251407e02,
        5.24142969e02,
        5.20585622e02,
        5.16486010e02,
        5.16020257e02,
        5.13017159e02,
        5.10933752e02,
        5.08819903e02,
        5.07357845e02,
        5.06128718e02,
        5.04127105e02,
        5.03787179e02,
        5.01799973e02,
        5.01590531e02,
        5.00540585e02,
        5.01687030e02,
        4.98494965e02,
        4.97843364e02,
        4.98878557e02,
        4.98679781e02,
        4.99360210e02,
        5.00478771e02,
        5.02431776e02,
        5.02862507e02,
        5.02636524e02,
        5.02139645e02,
        5.03776064e02,
        5.06358674e02,
        5.06631881e02,
        5.09067259e02,
        5.09579614e02,
        5.12146568e02,
        5.13180549e02,
        5.15762690e02,
        5.17201646e02,
        5.19944040e02,
        5.23523332e02,
        5.24536791e02,
        5.28586596e02,
        5.29133334e02,
        5.31325308e02,
        5.34884428e02,
        5.37088048e02,
        5.41864295e02,
        5.42997951e02,
        5.46937705e02,
        5.49462793e02,
        5.52908518e02,
        5.57127855e02,
        5.61743904e02,
        5.66049382e02,
        5.72589705e02,
        5.78182081e02,
        5.83616141e02,
        5.92029249e02,
        6.00582874e02,
        6.06957472e02,
        6.13106046e02,
        6.19657200e02,
        6.27711004e02,
        6.35343308e02,
        6.43913331e02,
        6.51980847e02,
        6.58247086e02,
        6.67034489e02,
        6.74663333e02,
        6.83182889e02,
        6.92355327e02,
        7.04651496e02,
        7.12680832e02,
        7.21794574e02,
        7.29632072e02,
        7.36834056e02,
        7.47037770e02,
        7.56274145e02,
        7.67517176e02,
        7.78136583e02,
        7.86192004e02,
        8.01163501e02,
        8.14858729e02,
        8.28291683e02,
        8.46690956e02,
        8.63261663e02,
        8.77916899e02,
        8.93466136e02,
        9.13291439e02,
        9.28395040e02,
        9.46908344e02,
        9.72867026e02,
        9.96352219e02,
        1.02182735e03,
        1.04668142e03,
        1.08322512e03,
        1.11182608e03,
        1.14676668e03,
        1.17349230e03,
        1.21319131e03,
        1.25178851e03,
        1.29762306e03,
        1.33932042e03,
        1.37965689e03,
        1.43276991e03,
        1.47655841e03,
        1.54400291e03,
        1.60202538e03,
        1.66722925e03,
        1.75361865e03,
        1.82670762e03,
        1.93027822e03,
        2.01421654e03,
        2.11195787e03,
        2.26406337e03,
        2.42722874e03,
        2.63222027e03,
        2.80435785e03,
        3.02479358e03,
        3.34278702e03,
        3.65861952e03,
        4.03828595e03,
        4.42421143e03,
        4.88597550e03,
        5.47565677e03,
        6.04212962e03,
        6.88358502e03,
        8.01444708e03,
        9.16598192e03,
        1.02234066e04,
        1.18932790e04,
        1.36146064e04,
        1.52465321e04,
        1.70802329e04,
        1.91896600e04,
        2.09578805e04,
        2.29773842e04,
        2.59592259e04,
        2.89503529e04,
        3.17549460e04,
        3.31480619e04,
        3.54971965e04,
        3.81688573e04,
        3.96127264e04,
        4.14086856e04,
        4.39680426e04,
        4.87003882e04,
        4.99023221e04,
        5.79024965e04,
        6.14565459e04,
        6.35120463e04,
        6.67641965e04,
        7.45356340e04,
        8.15832299e04,
        8.94997670e04,
        9.14315424e04,
        9.98791809e04,
        # Max out at 1e05
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1,
        1,
    ]
)

all_dist = np.array(
    [
        1.00000000e00,
        2.14136554e02,
        2.74848189e02,
        3.17455282e02,
        3.51229975e02,
        3.80320280e02,
        4.04333480e02,
        4.27179750e02,
        4.46079971e02,
        4.62208441e02,
        4.78737494e02,
        4.92992999e02,
        5.05092857e02,
        5.16277743e02,
        5.25563461e02,
        5.37672975e02,
        5.46104325e02,
        5.53554416e02,
        5.59509919e02,
        5.66738524e02,
        5.69482150e02,
        5.76403389e02,
        5.80302216e02,
        5.83583140e02,
        5.88942085e02,
        5.90772940e02,
        5.93926098e02,
        5.97525663e02,
        5.98049444e02,
        5.99569140e02,
        6.00489081e02,
        6.00943485e02,
        6.01417315e02,
        6.04076969e02,
        6.00604824e02,
        5.99459226e02,
        5.95482544e02,
        5.96610674e02,
        5.93200040e02,
        5.94012410e02,
        5.91274882e02,
        5.87658055e02,
        5.83077287e02,
        5.81105863e02,
        5.78556061e02,
        5.79363328e02,
        5.74068839e02,
        5.72048953e02,
        5.67976075e02,
        5.63955519e02,
        5.61098885e02,
        5.58452531e02,
        5.56506541e02,
        5.52260535e02,
        5.47551936e02,
        5.41973766e02,
        5.42847665e02,
        5.39006969e02,
        5.32446031e02,
        5.30555627e02,
        5.26180321e02,
        5.21268599e02,
        5.18669494e02,
        5.14562696e02,
        5.09945700e02,
        5.05277231e02,
        5.03666134e02,
        4.97533109e02,
        4.92121180e02,
        4.89567754e02,
        4.85034731e02,
        4.83903187e02,
        4.78605104e02,
        4.75537253e02,
        4.72135583e02,
        4.70204305e02,
        4.67187584e02,
        4.64860393e02,
        4.63212898e02,
        4.58681015e02,
        4.57302860e02,
        4.54279267e02,
        4.54495281e02,
        4.49056132e02,
        4.46897896e02,
        4.45665128e02,
        4.44282568e02,
        4.41842596e02,
        4.42445495e02,
        4.41913547e02,
        4.40301217e02,
        4.39005349e02,
        4.35428162e02,
        4.35744354e02,
        4.36638343e02,
        4.34932544e02,
        4.35209307e02,
        4.31709024e02,
        4.33591999e02,
        4.34128770e02,
        4.35183823e02,
        4.34726698e02,
        4.36117522e02,
        4.37111460e02,
        4.34438053e02,
        4.38054562e02,
        4.34728874e02,
        4.34962764e02,
        4.38088394e02,
        4.36737688e02,
        4.40335536e02,
        4.38899148e02,
        4.41301166e02,
        4.42611348e02,
        4.44593408e02,
        4.47323102e02,
        4.49106923e02,
        4.51668232e02,
        4.57012772e02,
        4.59669271e02,
        4.61907800e02,
        4.67997024e02,
        4.73643471e02,
        4.76727738e02,
        4.78102097e02,
        4.82559657e02,
        4.87629068e02,
        4.93833692e02,
        5.00156303e02,
        5.05227451e02,
        5.08545803e02,
        5.17207114e02,
        5.22743451e02,
        5.29579123e02,
        5.35161499e02,
        5.47510303e02,
        5.52219938e02,
        5.60669242e02,
        5.67048158e02,
        5.72363711e02,
        5.83299500e02,
        5.90759128e02,
        6.03200462e02,
        6.14049432e02,
        6.19224582e02,
        6.30952272e02,
        6.41571959e02,
        6.51271176e02,
        6.69328567e02,
        6.85860631e02,
        6.99016271e02,
        7.08740432e02,
        7.29950663e02,
        7.44601081e02,
        7.59082568e02,
        7.81914483e02,
        8.04809539e02,
        8.31207666e02,
        8.42537357e02,
        8.78392503e02,
        9.01671973e02,
        9.29546356e02,
        9.47871335e02,
        9.84223540e02,
        1.01981020e03,
        1.05659551e03,
        1.09454627e03,
        1.11465342e03,
        1.16296887e03,
        1.19497323e03,
        1.24995328e03,
        1.29738963e03,
        1.34926239e03,
        1.42747387e03,
        1.47928073e03,
        1.57273697e03,
        1.63882623e03,
        1.71359700e03,
        1.84375397e03,
        1.98201356e03,
        2.16493669e03,
        2.27935298e03,
        2.47071804e03,
        2.72445463e03,
        2.95642472e03,
        3.29539605e03,
        3.55923974e03,
        3.95322477e03,
        4.39140740e03,
        4.75223741e03,
        5.39086839e03,
        6.17472034e03,
        7.12707663e03,
        7.95216554e03,
        9.45725966e03,
        1.05830450e04,
        1.18302289e04,
        1.32122555e04,
        1.50488290e04,
        1.60114325e04,
        1.76401547e04,
        2.00902683e04,
        2.20115670e04,
        2.50003473e04,
        2.64541879e04,
        2.73093263e04,
        2.96960257e04,
        2.91491559e04,
        3.14137502e04,
        3.49603619e04,
        3.96627845e04,
        3.66416449e04,
        4.66545020e04,
        4.76510992e04,
        4.70334475e04,
        4.81313399e04,
        5.50786425e04,
        5.75916583e04,
        6.09002764e04,
        5.61036820e04,
        6.23511287e04,
        6.75551384e04,
        8.11197938e04,
        8.62980817e04,
        9.07499221e04,
        9.77729216e04,
        9.60099694e04,
        9.17565236e04,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1e05,
        1,
        1,
    ]
)
# 1.13173061e05,
# 1.32077816e05,
# 1.51287583e05,
# 1.68678840e05,
# 1.83922900e05,
# 1.94427324e05,
# 1.98593034e05,
# 2.32184415e05,
# 2.58967514e05,
# 2.73653190e05,
# 3.22705123e05,
# 3.66836819e05,
# 4.19429912e05,
# 5.25936833e05,
# 6.53748298e05,
# 8.00827684e05,
# 1.00447163e06,
# 1.32789725e06,
# 2.06204309e06,
# 2.63709173e06,
# 3.18424341e06,
# 3.71495065e06,
# 5.88784631e06,
# 9.36167563e06,
# 1.02875556e07,
# 1.58672468e07,
# 2.08037236e07,
# 3.22816401e07,
# 5.50686802e07,
# 1.87233513e08,
# 9.36167563e08,
# 9.36167563e08,
# 9.36167563e08,
